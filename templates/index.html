<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Website Analisis Klasifikasi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            background: #f6f9fc;
            font-family: "Segoe UI", sans-serif;
        }
        .container {
            margin-top: 40px;
            margin-bottom: 50px;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .metrics {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .metrics .box {
            background: #ffffff;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            width: 45%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        img {
            max-width: 100%;
            border-radius: 10px;
        }
        h5 {
            font-weight: bold;
        }
        
        /* CSS untuk detailed metrics */
        .detailed-metrics .card {
            margin-bottom: 0;
        }
        .detailed-metrics .table {
            font-size: 0.85rem;
            margin-bottom: 0;
        }
        .detailed-metrics .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }
        .detailed-metrics .table td {
            text-align: center;
            padding: 0.4rem 0.3rem;
        }
        .detailed-metrics tfoot {
            background-color: #e9ecef;
            font-weight: 600;
        }
        .metric-summary {
            text-align: left;
        }
        .metric-summary p {
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }
        .card-header h6 {
            font-size: 0.95rem;
        }

        /* CSS untuk analisis model */
        .analysis-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }
        .analysis-section h6 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .analysis-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .class-analysis {
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            margin-bottom: 8px;
        }
        .analysis-content ul {
            margin-bottom: 0;
            padding-left: 20px;
        }
        .analysis-content li {
            margin-bottom: 5px;
        }
        .model-comparison {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        /* CSS untuk analisis confusion matrix dan decision tree */
        .cm-analysis-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }
        .cm-analysis-item.good {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        .cm-analysis-item.warning {
            border-left-color: #ffc107;
            background-color: #fffef0;
        }
        .cm-analysis-item.info {
            border-left-color: #17a2b8;
            background-color: #f0f9ff;
        }
        .tree-feature-importance {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        .interpretation-guide {
            background: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        .interpretation-guide h6 {
            color: #495057;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">Website Analisia Data Penjualan Toko</h2>

    <!-- Upload Dataset -->
    <div class="card p-4 mb-4">
        <h5>üìÇ Upload Dataset (.csv)</h5>
        <input type="file" id="fileInput" class="form-control mb-3">
        <button id="uploadBtn" class="btn btn-primary">Proses Dataset</button>
    </div>

    <!-- Hasil -->
    <div id="results" style="display:none;">
        <div class="card p-4 mb-4">
            <h5>üìã Sampel Data (10 Baris Pertama)</h5>
            <div id="dataPreview" class="table-responsive mt-3"></div>
        </div>
        <!-- Hasil Evaluasi Model yang Diperluas -->
        <div class="card p-4 mb-4">
            <h5>üìä Hasil Evaluasi Model</h5>

            <!-- Detailed Classification Reports -->
            <div class="detailed-metrics mt-4">
                <div class="row">
                    <!-- Decision Tree Detailed Report -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">üìã Laporan Klasifikasi Decision Tree</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Kelas</th>
                                                <th>Precision</th>
                                                <th>Recall</th>
                                                <th>F1-Score</th>
                                                <th>Support</th>
                                            </tr>
                                        </thead>
                                        <tbody id="dt_report_body">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                        <tfoot id="dt_report_footer">
                                            <!-- Accuracy dan averages akan diisi oleh JavaScript -->
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Naive Bayes Detailed Report -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">üìã Laporan Klasifikasi Naive Bayes</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Kelas</th>
                                                <th>Precision</th>
                                                <th>Recall</th>
                                                <th>F1-Score</th>
                                                <th>Support</th>
                                            </tr>
                                        </thead>
                                        <tbody id="nb_report_body">
                                            <!-- Data akan diisi oleh JavaScript -->
                                        </tbody>
                                        <tfoot id="nb_report_footer">
                                            <!-- Accuracy dan averages akan diisi oleh JavaScript -->
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analisis Model -->
            <div class="card p-4 mt-4">
                <h5>üìà Analisis Model</h5>
                <div id="modelAnalysis" class="mt-3">
                    <!-- Analisis akan diisi oleh JavaScript -->
                </div>
            </div>
        </div>

        <!-- Confusion Matrix Individual dengan Analisis -->
        <div class="card p-4 mb-4">
            <h5>üî¢ Confusion Matrix (Individual)</h5>
            <div class="row text-center mt-3">
                <div class="col-md-6">
                    <h6>Decision Tree</h6>
                    <img id="dt_cm" alt="Confusion Matrix Decision Tree">
                </div>
                <div class="col-md-6">
                    <h6>Naive Bayes</h6>
                    <img id="nb_cm" alt="Confusion Matrix Naive Bayes">
                </div>
            </div>
            <!-- Analisis Confusion Matrix -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">üìä Analisis Confusion Matrix</h6>
                </div>
                <div class="card-body">
                    <div id="cmAnalysis" class="analysis-content">
                        <!-- Analisis akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Struktur Decision Tree dengan Analisis -->
        <div class="card p-4 mb-4">
            <h5>üå≥ Struktur Decision Tree</h5>
            <img id="tree_plot" class="mt-3" alt="Decision Tree Structure">
            <!-- Analisis Decision Tree -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">üîç Analisis Struktur Decision Tree</h6>
                </div>
                <div class="card-body">
                    <div id="treeAnalysis" class="analysis-content">
                        <!-- Analisis akan diisi oleh JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Prediksi Manual -->
        <div class="card p-4 mb-4">
            <h5>üìà Prediksi Manual</h5>
            <div id="predictForm" class="row g-2"></div>
            <button id="predictBtn" class="btn btn-success mt-3">Prediksi</button>

            <div id="predictionResult" class="alert alert-info mt-3" style="display:none;"></div>
        </div>
    </div>
</div>

<script>
$(document).ready(function(){
    let columns = [];

    // Upload dataset
    $("#uploadBtn").click(function(){
        let file = $("#fileInput")[0].files[0];
        if(!file) {
            alert("Pilih file CSV terlebih dahulu!");
            return;
        }
        let formData = new FormData();
        formData.append("file", file);

        $.ajax({
            url: "/upload",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function(res){
                console.log("Response dari server:", res); // Debug
                
                $("#results").show();
                $("#dataPreview").html(res.sample_table);
                
                // Tampilkan metrics dasar
                $("#acc_dt").text(res.metrics.decision_tree.accuracy);
                $("#f1_dt").text(res.metrics.decision_tree.f1);
                $("#acc_nb").text(res.metrics.naive_bayes.accuracy);
                $("#f1_nb").text(res.metrics.naive_bayes.f1);

                // Tampilkan gambar
                $("#dt_cm").attr("src", res.images.dt_confusion);
                $("#nb_cm").attr("src", res.images.nb_confusion);
                if(res.images.tree_plot){
                    $("#tree_plot").attr("src", res.images.tree_plot);
                }

                // Tampilkan detailed metrics jika ada
                if (res.detailed_metrics) {
                    console.log("Detailed metrics tersedia:", res.detailed_metrics);
                    displayDetailedMetrics(res.detailed_metrics);
                    // Tampilkan analisis model
                    displayModelAnalysis(res.metrics, res.detailed_metrics, res.target_column || "target");
                    // Tampilkan analisis confusion matrix
                    displayConfusionMatrixAnalysis(res.metrics, res.detailed_metrics);
                    // Tampilkan analisis decision tree
                    displayTreeAnalysis(res.metrics, res.columns);
                } else {
                    console.log("Detailed metrics tidak tersedia");
                    // Fallback: tampilkan pesan
                    $("#dt_report_body").html('<tr><td colspan="5" class="text-center">Data tidak tersedia</td></tr>');
                    $("#nb_report_body").html('<tr><td colspan="5" class="text-center">Data tidak tersedia</td></tr>');
                    // Tampilkan analisis dasar saja
                    displayModelAnalysis(res.metrics, null, res.target_column || "target");
                    displayConfusionMatrixAnalysis(res.metrics, null);
                    displayTreeAnalysis(res.metrics, res.columns);
                }

                // buat form prediksi
                columns = res.columns;
                let formHtml = "";
                for(let c of columns){
                    let safeId = c.replace(/[^a-zA-Z0-9_-]/g, "_");
                    formHtml += `
                    <div class="col-md-4">
                      <label>${c}</label>
                      <input type="text" class="form-control" id="input_${safeId}" data-col="${c}" placeholder="Masukkan ${c}">
                    </div>
                  `;
                }
                $("#predictForm").html(formHtml);
            },
            error: function(err){
                console.error("Error:", err);
                alert("Gagal memproses dataset: " + (err.responseJSON?.error || "Unknown error"));
            }
        });
    });

    // Fungsi untuk menampilkan detailed metrics
    function displayDetailedMetrics(metrics) {
        console.log("Display detailed metrics:", metrics);
        
        // Decision Tree Detailed Report
        const dtBody = document.getElementById('dt_report_body');
        const dtFooter = document.getElementById('dt_report_footer');
        
        // Naive Bayes Detailed Report
        const nbBody = document.getElementById('nb_report_body');
        const nbFooter = document.getElementById('nb_report_footer');
        
        // Clear existing content
        dtBody.innerHTML = '';
        nbBody.innerHTML = '';
        dtFooter.innerHTML = '';
        nbFooter.innerHTML = '';
        
        // Populate Decision Tree table
        if (metrics.decision_tree && metrics.decision_tree.classes && metrics.decision_tree.classes.length > 0) {
            console.log("DT Classes:", metrics.decision_tree.classes);
            
            metrics.decision_tree.classes.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cls.name}</td>
                    <td>${(cls.precision || 0).toFixed(2)}</td>
                    <td>${(cls.recall || 0).toFixed(2)}</td>
                    <td>${(cls.f1_score || 0).toFixed(2)}</td>
                    <td>${cls.support || 0}</td>
                `;
                dtBody.appendChild(row);
            });
            
            // Footer untuk Decision Tree
            if (metrics.decision_tree.macro_avg && metrics.decision_tree.weighted_avg) {
                dtFooter.innerHTML = `
                    <tr>
                        <td><strong>Accuracy</strong></td>
                        <td colspan="3"></td>
                        <td><strong>${(metrics.decision_tree.accuracy || 0).toFixed(2)}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Macro Avg</strong></td>
                        <td>${(metrics.decision_tree.macro_avg.precision || 0).toFixed(2)}</td>
                        <td>${(metrics.decision_tree.macro_avg.recall || 0).toFixed(2)}</td>
                        <td>${(metrics.decision_tree.macro_avg.f1_score || 0).toFixed(2)}</td>
                        <td>${metrics.decision_tree.macro_avg.support || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Weighted Avg</strong></td>
                        <td>${(metrics.decision_tree.weighted_avg.precision || 0).toFixed(2)}</td>
                        <td>${(metrics.decision_tree.weighted_avg.recall || 0).toFixed(2)}</td>
                        <td>${(metrics.decision_tree.weighted_avg.f1_score || 0).toFixed(2)}</td>
                        <td>${metrics.decision_tree.weighted_avg.support || 0}</td>
                    </tr>
                `;
            }
        } else {
            dtBody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data kelas</td></tr>';
        }
        
        // Populate Naive Bayes table
        if (metrics.naive_bayes && metrics.naive_bayes.classes && metrics.naive_bayes.classes.length > 0) {
            console.log("NB Classes:", metrics.naive_bayes.classes);
            
            metrics.naive_bayes.classes.forEach(cls => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cls.name}</td>
                    <td>${(cls.precision || 0).toFixed(2)}</td>
                    <td>${(cls.recall || 0).toFixed(2)}</td>
                    <td>${(cls.f1_score || 0).toFixed(2)}</td>
                    <td>${cls.support || 0}</td>
                `;
                nbBody.appendChild(row);
            });
            
            // Footer untuk Naive Bayes
            if (metrics.naive_bayes.macro_avg && metrics.naive_bayes.weighted_avg) {
                nbFooter.innerHTML = `
                    <tr>
                        <td><strong>Accuracy</strong></td>
                        <td colspan="3"></td>
                        <td><strong>${(metrics.naive_bayes.accuracy || 0).toFixed(2)}</strong></td>
                    </tr>
                    <tr>
                        <td><strong>Macro Avg</strong></td>
                        <td>${(metrics.naive_bayes.macro_avg.precision || 0).toFixed(2)}</td>
                        <td>${(metrics.naive_bayes.macro_avg.recall || 0).toFixed(2)}</td>
                        <td>${(metrics.naive_bayes.macro_avg.f1_score || 0).toFixed(2)}</td>
                        <td>${metrics.naive_bayes.macro_avg.support || 0}</td>
                    </tr>
                    <tr>
                        <td><strong>Weighted Avg</strong></td>
                        <td>${(metrics.naive_bayes.weighted_avg.precision || 0).toFixed(2)}</td>
                        <td>${(metrics.naive_bayes.weighted_avg.recall || 0).toFixed(2)}</td>
                        <td>${(metrics.naive_bayes.weighted_avg.f1_score || 0).toFixed(2)}</td>
                        <td>${metrics.naive_bayes.weighted_avg.support || 0}</td>
                    </tr>
                `;
            }
        } else {
            nbBody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data kelas</td></tr>';
        }
    }

    // Fungsi untuk menampilkan analisis model
    function displayModelAnalysis(metrics, detailedMetrics, targetColumn) {
        const analysisContainer = document.getElementById('modelAnalysis');
        if (!analysisContainer) return;

        let analysisHTML = '';
        
        // Analisis Performa Model
        analysisHTML += `
            <div class="analysis-section">
                <h6>üéØ Performa Model</h6>
                <div class="analysis-content">
        `;

        // Bandingkan akurasi
        const accDT = metrics.decision_tree.accuracy;
        const accNB = metrics.naive_bayes.accuracy;
        const f1DT = metrics.decision_tree.f1;
        const f1NB = metrics.naive_bayes.f1;

        // Box perbandingan
        analysisHTML += `
            <div class="model-comparison text-center">
                <h6 style="color: white">Perbandingan Akurasi</h6>
                <div class="row">
                    <div class="col-6">
                        <h4>${(accDT * 100).toFixed(1)}%</h4>
                        <small>Decision Tree</small>
                    </div>
                    <div class="col-6">
                        <h4>${(accNB * 100).toFixed(1)}%</h4>
                        <small>Naive Bayes</small>
                    </div>
                </div>
            </div>
        `;

        if (accDT > accNB) {
            analysisHTML += `
                <p><strong>Decision Tree lebih akurat</strong> (${(accDT * 100).toFixed(2)}% vs ${(accNB * 100).toFixed(2)}%)</p>
            `;
        } else if (accNB > accDT) {
            analysisHTML += `
                <p><strong>Naive Bayes lebih akurat</strong> (${(accNB * 100).toFixed(2)}% vs ${(accDT * 100).toFixed(2)}%)</p>
            `;
        } else {
            analysisHTML += `<p><strong>Kedua model memiliki akurasi yang sama</strong></p>`;
        }

        // Analisis F1-Score
        if (f1DT > f1NB) {
            analysisHTML += `<p><strong>Decision Tree memiliki F1-Score lebih baik</strong> (${f1DT.toFixed(4)} vs ${f1NB.toFixed(4)})</p>`;
        } else if (f1NB > f1DT) {
            analysisHTML += `<p><strong>Naive Bayes memiliki F1-Score lebih baik</strong> (${f1NB.toFixed(4)} vs ${f1DT.toFixed(4)})</p>`;
        }

        analysisHTML += `</div></div>`;

        // Analisis Kelas (jika detailed metrics tersedia)
        if (detailedMetrics && detailedMetrics.decision_tree && detailedMetrics.naive_bayes) {
            analysisHTML += `
                <div class="analysis-section mt-3">
                    <h6>üîç Analisis per Kelas</h6>
                    <div class="analysis-content">
            `;

            const dtClasses = detailedMetrics.decision_tree.classes;
            const nbClasses = detailedMetrics.naive_bayes.classes;

            if (dtClasses && nbClasses && dtClasses.length > 0) {
                dtClasses.forEach((dtClass, index) => {
                    const nbClass = nbClasses[index];
                    if (dtClass && nbClass) {
                        analysisHTML += `
                            <div class="class-analysis">
                                <strong>Kelas: ${dtClass.name}</strong>
                                <div class="ms-3">
                                    <small>
                                        <strong>Decision Tree:</strong> Precision=${dtClass.precision.toFixed(2)}, Recall=${dtClass.recall.toFixed(2)}, F1=${dtClass.f1_score.toFixed(2)}<br>
                                        <strong>Naive Bayes:</strong> Precision=${nbClass.precision.toFixed(2)}, Recall=${nbClass.recall.toFixed(2)}, F1=${nbClass.f1_score.toFixed(2)}
                                    </small>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            analysisHTML += `</div></div>`;
        }

        // Rekomendasi Model
        analysisHTML += `
            <div class="analysis-section mt-3">
                <h6>üí° Rekomendasi</h6>
                <div class="analysis-content">
        `;

        const accuracyDiff = Math.abs(accDT - accNB);
        
        if (accuracyDiff < 0.05) {
            analysisHTML += `
                <p>Kedua model memiliki performa yang cukup seimbang. Pertimbangkan:</p>
                <ul>
                    <li><strong>Decision Tree</strong> jika perlu interpretasi yang mudah dan memahami pola decision</li>
                    <li><strong>Naive Bayes</strong> jika mengutamakan kecepatan dan dataset memiliki independensi fitur</li>
                </ul>
            `;
        } else if (accDT > accNB) {
            analysisHTML += `
                <p><strong>Rekomendasi: Gunakan Decision Tree</strong></p>
                <ul>
                    <li>Lebih akurat dalam memprediksi ${targetColumn}</li>
                    <li>Mampu menangkap hubungan non-linear dalam data</li>
                    <li>Memberikan insight tentang feature importance</li>
                </ul>
            `;
        } else {
            analysisHTML += `
                <p><strong>Rekomendasi: Gunakan Naive Bayes</strong></p>
                <ul>
                    <li>Lebih akurat dalam memprediksi ${targetColumn}</li>
                    <li>Lebih cepat dalam training dan prediction</li>
                    <li>Robust terhadap noise dalam data</li>
                </ul>
            `;
        }

        // Catatan tentang perbedaan prediksi
        analysisHTML += `
            <div class="alert alert-warning mt-2">
                <small>
                    <strong>Catatan:</strong> Perbedaan prediksi antara model adalah hal normal. 
                    Decision Tree cenderung lebih kompleks sedangkan Naive Bayes membuat asumsi independensi.
                    Pilih model dengan akurasi tertinggi untuk prediksi yang lebih reliable.
                </small>
            </div>
        `;

        analysisHTML += `</div></div>`;

        analysisContainer.innerHTML = analysisHTML;
    }

    // Fungsi untuk menampilkan analisis confusion matrix
    function displayConfusionMatrixAnalysis(metrics, detailedMetrics) {
        const cmAnalysisContainer = document.getElementById('cmAnalysis');
        if (!cmAnalysisContainer) return;

        let analysisHTML = '';
        
        // Analisis umum confusion matrix
        analysisHTML += `
            <div class="cm-analysis-item info">
                <h6>üìà Interpretasi Confusion Matrix</h6>
                <p><strong>Diagonal utama</strong> menunjukkan prediksi yang benar (True Positive & True Negative)</p>
                <p><strong>Diagonal lainnya</strong> menunjukkan kesalahan prediksi (False Positive & False Negative)</p>
            </div>
        `;

        // Analisis per model jika detailed metrics tersedia
        if (detailedMetrics && detailedMetrics.decision_tree && detailedMetrics.naive_bayes) {
            const dtClasses = detailedMetrics.decision_tree.classes;
            const nbClasses = detailedMetrics.naive_bayes.classes;

            if (dtClasses && nbClasses && dtClasses.length > 0) {
                // Analisis Decision Tree
                analysisHTML += `
                    <div class="cm-analysis-item">
                        <h6>üå≥ Decision Tree Performance</h6>
                `;

                dtClasses.forEach(cls => {
                    const precision = (cls.precision || 0).toFixed(2);
                    const recall = (cls.recall || 0).toFixed(2);
                    
                    let performanceNote = '';
                    if (precision > 0.8 && recall > 0.8) {
                        performanceNote = '<span class="badge bg-success">Excellent</span>';
                    } else if (precision > 0.6 && recall > 0.6) {
                        performanceNote = '<span class="badge bg-warning">Good</span>';
                    } else {
                        performanceNote = '<span class="badge bg-danger">Needs Improvement</span>';
                    }

                    analysisHTML += `
                        <div class="ms-3 mb-2">
                            <strong>${cls.name}:</strong> Precision=${precision}, Recall=${recall} ${performanceNote}
                        </div>
                    `;
                });

                analysisHTML += `</div>`;

                // Analisis Naive Bayes
                analysisHTML += `
                    <div class="cm-analysis-item">
                        <h6>ü§ñ Naive Bayes Performance</h6>
                `;

                nbClasses.forEach(cls => {
                    const precision = (cls.precision || 0).toFixed(2);
                    const recall = (cls.recall || 0).toFixed(2);
                    
                    let performanceNote = '';
                    if (precision > 0.8 && recall > 0.8) {
                        performanceNote = '<span class="badge bg-success">Excellent</span>';
                    } else if (precision > 0.6 && recall > 0.6) {
                        performanceNote = '<span class="badge bg-warning">Good</span>';
                    } else {
                        performanceNote = '<span class="badge bg-danger">Needs Improvement</span>';
                    }

                    analysisHTML += `
                        <div class="ms-3 mb-2">
                            <strong>${cls.name}:</strong> Precision=${precision}, Recall=${recall} ${performanceNote}
                        </div>
                    `;
                });

                analysisHTML += `</div>`;
            }
        }

        // Tips untuk membaca confusion matrix
        analysisHTML += `
            <div class="interpretation-guide">
                <h6>üéØ Cara Membaca Confusion Matrix:</h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>True Positive (TP):</strong> Prediksi POSITIF yang benar<br>
                        <strong>False Positive (FP):</strong> Prediksi POSITIF yang salah (Type I Error)
                    </div>
                    <div class="col-md-6">
                        <strong>True Negative (TN):</strong> Prediksi NEGATIF yang benar<br>
                        <strong>False Negative (FN):</strong> Prediksi NEGATIF yang salah (Type II Error)
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        <strong>Goal:</strong> Maximize diagonal utama (TP & TN), minimize FP dan FN
                    </small>
                </div>
            </div>
        `;

        cmAnalysisContainer.innerHTML = analysisHTML;
    }

    // Fungsi untuk menampilkan analisis struktur decision tree
    function displayTreeAnalysis(metrics, columns) {
        const treeAnalysisContainer = document.getElementById('treeAnalysis');
        if (!treeAnalysisContainer) return;

        let analysisHTML = '';

        // Analisis kompleksitas tree
        analysisHTML += `
            <div class="cm-analysis-item info">
                <h6>üå≥ Interpretasi Struktur Decision Tree</h6>
                <p>Decision Tree membagi data berdasarkan fitur-fitur paling informatif</p>
                <p><strong>Node atas</strong> menunjukkan fitur paling penting untuk klasifikasi</p>
                <p><strong>Kedalaman tree</strong> menunjukkan kompleksitas model</p>
            </div>
        `;

        // Feature importance (simulasi berdasarkan akurasi)
if (columns && columns.length > 0) {
    analysisHTML += `
        <div class="tree-feature-importance text-center">
            <h6>üéØ Feature Importance (Estimasi)</h6>
            <p class="mb-3">Berdasarkan struktur tree, fitur di node atas memiliki pengaruh terbesar dalam pengambilan keputusan</p>
            <div class="row justify-content-center">
    `;

    // Tampilkan 5 fitur pertama sebagai yang paling penting (simulasi)
    const topFeatures = columns.slice(0, Math.min(5, columns.length));
    
    topFeatures.forEach((feature, index) => {
        const importance = (100 - index * 18) + '%'; // Simulasi importance yang lebih realistis
        
        // Berikan warna yang berbeda berdasarkan ranking
        let importanceClass = '';
        let importanceBadge = '';
        
        if (index === 0) {
            importanceClass = 'text-warning';
            importanceBadge = '<span class="badge bg-warning">üèÜ Top</span>';
        } else if (index === 1) {
            importanceClass = 'text-info';
            importanceBadge = '<span class="badge bg-info">ü•à High</span>';
        } else if (index === 2) {
            importanceClass = 'text-primary';
            importanceBadge = '<span class="badge bg-primary">ü•â Medium</span>';
        } else {
            importanceClass = 'text-secondary';
            importanceBadge = '<span class="badge bg-secondary">Low</span>';
        }

        analysisHTML += `
            <div class="col-lg-2 col-md-4 col-6 mb-3">
                <div class="feature-card p-3 bg-white rounded shadow-sm">
                    <div class="feature-rank ${importanceClass} mb-2">
                        <strong>#${index + 1}</strong>
                    </div>
                    <div class="feature-percentage ${importanceClass} mb-2">
                        <h4 class="mb-1"><strong>${importance}</strong></h4>
                        ${importanceBadge}
                    </div>
                    <div class="feature-name">
                        <small class="text-muted d-block" style="font-size: 0.75rem; line-height: 1.2;">
                            ${feature.length > 20 ? feature.substring(0, 20) + '...' : feature}
                        </small>
                        ${feature.length > 20 ? 
                            `<small class="text-muted" title="${feature}">${feature}</small>` : 
                            ''
                        }
                    </div>
                </div>
            </div>
        `;
    });

    analysisHTML += `
            </div>
            <div class="mt-3">
                <small class="text-light">
                    <i>Fitur dengan importance tinggi memiliki pengaruh lebih besar dalam klasifikasi</i>
                </small>
            </div>
        </div>
    `;
}

        // Analisis performa decision tree
        if (metrics && metrics.decision_tree) {
            const accuracy = (metrics.decision_tree.accuracy * 100).toFixed(1);
            const f1 = metrics.decision_tree.f1.toFixed(4);
            
            let complexityNote = '';
            if (metrics.decision_tree.accuracy > 0.9) {
                complexityNote = '<span class="badge bg-success">Optimal Complexity</span>';
            } else if (metrics.decision_tree.accuracy > 0.7) {
                complexityNote = '<span class="badge bg-warning">Moderate Complexity</span>';
            } else {
                complexityNote = '<span class="badge bg-danger">Possible Overfitting/Underfitting</span>';
            }

            analysisHTML += `
                <div class="cm-analysis-item ${metrics.decision_tree.accuracy > 0.8 ? 'good' : 'warning'}">
                    <h6>üìä Analisis Kompleksitas Model</h6>
                    <p><strong>Akurasi:</strong> ${accuracy}% | <strong>F1-Score:</strong> ${f1}</p>
                    <p><strong>Status Kompleksitas:</strong> ${complexityNote}</p>
                    <div class="ms-3">
                        <small>
                            ${metrics.decision_tree.accuracy > 0.9 ? 
                                '‚úì Tree memiliki kompleksitas yang optimal' :
                            metrics.decision_tree.accuracy > 0.7 ?
                                '‚óã Tree mungkin perlu tuning parameter' :
                                '‚úó Tree mungkin overfitting atau underfitting'}
                        </small>
                    </div>
                </div>
            `;
        }

        // Panduan interpretasi
        analysisHTML += `
            <div class="interpretation-guide">
                <h6>üîç Cara Membaca Decision Tree:</h6>
                <ul>
                    <li><strong>Node (Kotak):</strong> Keputusan berdasarkan fitur tertentu</li>
                    <li><strong>Branch (Garis):</strong> Hasil dari keputusan (True/False)</li>
                    <li><strong>Leaf (Daun):</strong> Hasil akhir prediksi kelas</li>
                    <li><strong>Warna:</strong> Menunjukkan kemurnian kelas (biru=kelas 1, oranye=kelas 2)</li>
                </ul>
                <div class="mt-2">
                    <small class="text-muted">
                        <strong>Tip:</strong> Semakin dalam tree, semakin kompleks model. Cari balance antara akurasi dan interpretability.
                    </small>
                </div>
            </div>
        `;

        treeAnalysisContainer.innerHTML = analysisHTML;
    }

    // Prediksi manual
    $("#predictBtn").click(function(){
        if(columns.length === 0){
            alert("Upload dataset dulu!");
            return;
        }
        let payload = {};
        for(let c of columns){
          let safeId = c.replace(/[^a-zA-Z0-9_-]/g, "_");
          payload[c] = $("#input_" + safeId).val();
        }
        
        $.ajax({
            url: "/predict",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(payload),
            success: function(res){
                let pred = res.prediction;
                $("#predictionResult").show().html(`
                    <h6>üéØ Hasil Prediksi:</h6>
                    <p><b>Decision Tree:</b> ${pred.decision_tree}</p>
                    <p><b>Naive Bayes:</b> ${pred.naive_bayes}</p>
                    <div class="alert alert-info mt-2">
                        <small>
                            <strong>Tips:</strong> Gunakan model dengan akurasi tertinggi dari hasil evaluasi di atas.
                            Jika prediksi berbeda, periksa confusion matrix untuk memahami pola kesalahan model.
                        </small>
                    </div>
                `);
            },
            error: function(err){
                alert("Gagal melakukan prediksi: " + (err.responseJSON?.error || "Unknown error"));
            }
        });
    });
});
</script>

</body>
</html>